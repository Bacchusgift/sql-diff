name: Release

on:
  push:
    tags:
      - 'v*'      # ÂΩìÊé®ÈÄÅ v1.0.2 ËøôÊ†∑ÁöÑ tag Êó∂Ëß¶Âèë
      - '[0-9]+.*' # ‰πüÊîØÊåÅ 1.0.2 ËøôÊ†∑ÁöÑ tag

permissions:
  contents: write

jobs:
  # Á¨¨‰∏ÄÊ≠•ÔºöËøêË°å CI ÊµãËØï
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Verify dependencies
        run: go mod verify

      - name: Run go vet
        run: go vet ./...

      - name: Run go fmt
        run: |
          if [ -n "$(gofmt -s -l .)" ]; then
            echo "Go code is not formatted:"
            gofmt -s -d .
            exit 1
          fi

      - name: Run tests
        run: make test

  # Á¨¨‰∫åÊ≠•ÔºöÊûÑÂª∫Âπ∂ÂèëÂ∏É
  release:
    name: Build and Release
    needs: test  # ÂøÖÈ°ªÁ≠âÂæÖÊµãËØïÈÄöËøá
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.VERSION }}
      sha256: ${{ steps.sha256.outputs.sha256 }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      - name: Get version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ ÂáÜÂ§áÂèëÂ∏ÉÁâàÊú¨: $VERSION"

      - name: Build all platforms
        run: make release
        env:
          VERSION: ${{ steps.get_version.outputs.VERSION }}

      - name: Display build artifacts
        run: |
          echo "üì¶ ÊûÑÂª∫‰∫ßÁâ©ÂàóË°®:"
          ls -lh dist/
          echo ""
          echo "üìù Ê†°È™åÂíå:"
          cat dist/checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          generate_release_notes: true
          files: |
            dist/sql-diff-linux-amd64
            dist/sql-diff-linux-arm64
            dist/sql-diff-darwin-amd64
            dist/sql-diff-darwin-arm64
            dist/sql-diff-windows-amd64.exe
            dist/sql-diff-windows-arm64.exe
            dist/checksums.txt
          body: |
            ## üì¶ ÂÆâË£ÖÊñπÂºè

            ### macOS (Homebrew)
            ```bash
            brew install Bacchusgift/tap/sql-diff
            ```

            ### ÊâãÂä®ÂÆâË£Ö
            ‰ªé‰∏ãÊñπ Assets ‰∏ãËΩΩÂØπÂ∫îÂπ≥Âè∞ÁöÑ‰∫åËøõÂà∂Êñá‰ª∂Ôºö
            - **Linux AMD64**: `sql-diff-linux-amd64`
            - **Linux ARM64**: `sql-diff-linux-arm64`
            - **macOS Intel**: `sql-diff-darwin-amd64`
            - **macOS Apple Silicon**: `sql-diff-darwin-arm64`
            - **Windows AMD64**: `sql-diff-windows-amd64.exe`
            - **Windows ARM64**: `sql-diff-windows-arm64.exe`

            ‰∏ãËΩΩÂêéËµã‰∫àÊâßË°åÊùÉÈôêÔºàmacOS/LinuxÔºâÔºö
            ```bash
            chmod +x sql-diff-*
            sudo mv sql-diff-* /usr/local/bin/sql-diff
            ```

            ### È™åËØÅÂÆâË£Ö
            ```bash
            sql-diff --version
            ```

            ---

            ## üìö ÊñáÊ°£
            ÂÆåÊï¥ÊñáÊ°£ËØ∑ËÆøÈóÆÔºöhttps://bacchusgift.github.io/sql-diff/
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Calculate SHA256 for Homebrew
        id: sha256
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          TARBALL_URL="https://github.com/${{ github.repository }}/archive/refs/tags/${VERSION}.tar.gz"
          
          echo "‚è≥ Á≠âÂæÖ GitHub ÁîüÊàê tarball..."
          sleep 10
          
          echo "üì• ‰∏ãËΩΩ: $TARBALL_URL"
          SHA256=$(curl -sL "$TARBALL_URL" | shasum -a 256 | awk '{print $1}')
          
          echo "‚úÖ SHA256: $SHA256"
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT

      - name: Update Homebrew Formula (Auto)
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          SHA256=${{ steps.sha256.outputs.sha256 }}
          
          echo "üìù Homebrew Formula Êõ¥Êñ∞‰ø°ÊÅØÔºö"
          echo "   Version: $VERSION"
          echo "   SHA256: $SHA256"
          echo "   URL: https://github.com/${{ github.repository }}/archive/refs/tags/${VERSION}.tar.gz"
          echo ""
          echo "‚úÖ Homebrew Tap Â∞ÜÂú®‰∏ã‰∏ÄÊ≠•Ëá™Âä®Êõ¥Êñ∞"

  # üöÄ Á¨¨‰∏âÊ≠•ÔºöËá™Âä®Êõ¥Êñ∞ Homebrew Tap
  update-homebrew:
    name: Update Homebrew Formula
    needs: release
    runs-on: ubuntu-latest
    if: github.repository == 'Bacchusgift/sql-diff'
    steps:
      - name: Checkout homebrew-tap repository
        uses: actions/checkout@v4
        with:
          repository: Bacchusgift/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN || secrets.GITHUB_TOKEN }}
          path: homebrew-tap

      - name: Update Formula
        run: |
          cd homebrew-tap
          VERSION="${{ needs.release.outputs.version }}"
          SHA256="${{ needs.release.outputs.sha256 }}"
          
          cat > Formula/sql-diff.rb << 'EOF'
          class SqlDiff < Formula
            desc "Êô∫ËÉΩ SQL Ë°®ÁªìÊûÑÊØîÂØπÂ∑•ÂÖ∑ÔºåÊîØÊåÅ‰∫§‰∫íÂºèÂ§öË°åËæìÂÖ•Âíå AI ÂàÜÊûê"
            homepage "https://bacchusgift.github.io/sql-diff/"
            url "https://github.com/Bacchusgift/sql-diff/archive/refs/tags/${VERSION}.tar.gz"
            sha256 "${SHA256}"
            license "MIT"
            head "https://github.com/Bacchusgift/sql-diff.git", branch: "main"

            depends_on "go" => :build

            def install
              ldflags = %W[
                -s -w
                -X main.Version=#{version}
                -X main.BuildTime=#{time.iso8601}
                -X main.GitCommit=#{Utils.git_short_head}
              ]

              system "go", "build", *std_go_args(ldflags: ldflags), "./cmd/sql-diff"
              generate_completions_from_executable(bin/"sql-diff", "completion")
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/sql-diff --version")
              
              source_sql = "CREATE TABLE users (id INT PRIMARY KEY, name VARCHAR(100));"
              target_sql = "CREATE TABLE users (id INT PRIMARY KEY, name VARCHAR(100), email VARCHAR(255));"
              
              output = shell_output("#{bin}/sql-diff -s '#{source_sql}' -t '#{target_sql}'")
              assert_match "ADD COLUMN email", output
            end
          end
          EOF
          
          # ÊõøÊç¢ÂèòÈáè
          sed -i "s/\${VERSION}/$VERSION/g" Formula/sql-diff.rb
          sed -i "s/\${SHA256}/$SHA256/g" Formula/sql-diff.rb
          
          echo "‚úÖ Formula Â∑≤Êõ¥Êñ∞:"
          cat Formula/sql-diff.rb

      - name: Commit and push
        run: |
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add Formula/sql-diff.rb
          git commit -m "chore: update sql-diff to ${{ needs.release.outputs.version }}"
          git push origin main
          
          echo "üéâ Homebrew Formula Â∑≤Ëá™Âä®Êõ¥Êñ∞ÔºÅ"
