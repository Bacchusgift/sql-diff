name: Release

on:
  push:
    tags:
      - 'v*'      # å½“æŽ¨é€ v1.0.2 è¿™æ ·çš„ tag æ—¶è§¦å‘
      - '[0-9]+.*' # ä¹Ÿæ”¯æŒ 1.0.2 è¿™æ ·çš„ tag

permissions:
  contents: write

jobs:
  # ç¬¬ä¸€æ­¥ï¼šè¿è¡Œ CI æµ‹è¯•
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Verify dependencies
        run: go mod verify

      - name: Run go vet
        run: go vet ./...

      - name: Run go fmt
        run: |
          if [ -n "$(gofmt -s -l .)" ]; then
            echo "Go code is not formatted:"
            gofmt -s -d .
            exit 1
          fi

      - name: Run tests
        run: make test

  # ç¬¬äºŒæ­¥ï¼šæž„å»ºå¹¶å‘å¸ƒ
  release:
    name: Build and Release
    needs: test  # å¿…é¡»ç­‰å¾…æµ‹è¯•é€šè¿‡
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.VERSION }}
      sha256: ${{ steps.sha256.outputs.sha256 }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      - name: Get version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ å‡†å¤‡å‘å¸ƒç‰ˆæœ¬: $VERSION"

      - name: Build all platforms
        run: make release
        env:
          VERSION: ${{ steps.get_version.outputs.VERSION }}

      - name: Display build artifacts
        run: |
          echo "ðŸ“¦ æž„å»ºäº§ç‰©åˆ—è¡¨:"
          ls -lh dist/
          echo ""
          echo "ðŸ“ æ ¡éªŒå’Œ:"
          cat dist/checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          generate_release_notes: true
          files: |
            dist/sql-diff-linux-amd64
            dist/sql-diff-linux-arm64
            dist/sql-diff-darwin-amd64
            dist/sql-diff-darwin-arm64
            dist/sql-diff-windows-amd64.exe
            dist/sql-diff-windows-arm64.exe
            dist/checksums.txt
          body: |
            ## ðŸ“¦ å®‰è£…æ–¹å¼

            ### macOS (Homebrew)
            ```bash
            brew install Bacchusgift/tap/sql-diff
            ```

            ### æ‰‹åŠ¨å®‰è£…
            ä»Žä¸‹æ–¹ Assets ä¸‹è½½å¯¹åº”å¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼š
            - **Linux AMD64**: `sql-diff-linux-amd64`
            - **Linux ARM64**: `sql-diff-linux-arm64`
            - **macOS Intel**: `sql-diff-darwin-amd64`
            - **macOS Apple Silicon**: `sql-diff-darwin-arm64`
            - **Windows AMD64**: `sql-diff-windows-amd64.exe`
            - **Windows ARM64**: `sql-diff-windows-arm64.exe`

            ä¸‹è½½åŽèµ‹äºˆæ‰§è¡Œæƒé™ï¼ˆmacOS/Linuxï¼‰ï¼š
            ```bash
            chmod +x sql-diff-*
            sudo mv sql-diff-* /usr/local/bin/sql-diff
            ```

            ### éªŒè¯å®‰è£…
            ```bash
            sql-diff --version
            ```

            ---

            ## ðŸ“š æ–‡æ¡£
            å®Œæ•´æ–‡æ¡£è¯·è®¿é—®ï¼šhttps://bacchusgift.github.io/sql-diff/
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Calculate SHA256 for Homebrew
        id: sha256
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          TARBALL_URL="https://github.com/${{ github.repository }}/archive/refs/tags/${VERSION}.tar.gz"
          
          echo "â³ ç­‰å¾… GitHub ç”Ÿæˆ tarball..."
          sleep 10
          
          echo "ðŸ“¥ ä¸‹è½½: $TARBALL_URL"
          SHA256=$(curl -sL "$TARBALL_URL" | shasum -a 256 | awk '{print $1}')
          
          echo "âœ… SHA256: $SHA256"
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT

      - name: Update Homebrew Formula (Auto)
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          SHA256=${{ steps.sha256.outputs.sha256 }}
          
          echo "ðŸ“ Homebrew Formula æ›´æ–°ä¿¡æ¯ï¼š"
          echo "   Version: $VERSION"
          echo "   SHA256: $SHA256"
          echo "   URL: https://github.com/${{ github.repository }}/archive/refs/tags/${VERSION}.tar.gz"
          echo ""
          echo "âœ… Homebrew Tap å°†åœ¨ä¸‹ä¸€æ­¥è‡ªåŠ¨æ›´æ–°"

  # ðŸš€ ç¬¬ä¸‰æ­¥ï¼šè‡ªåŠ¨æ›´æ–° Homebrew Tap
  update-homebrew:
    name: Update Homebrew Formula
    needs: release
    runs-on: ubuntu-latest
    if: github.repository == 'Bacchusgift/sql-diff'
    steps:
      - name: Checkout homebrew-tap repository
        uses: actions/checkout@v4
        with:
          repository: Bacchusgift/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN || secrets.GITHUB_TOKEN }}
          path: homebrew-tap

      - name: Update Formula
        run: |
          cd homebrew-tap
          VERSION="${{ needs.release.outputs.version }}"
          SHA256="${{ needs.release.outputs.sha256 }}"
          
          cat > Formula/sql-diff.rb << 'EOF'
          class SqlDiff < Formula
            desc "æ™ºèƒ½ SQL è¡¨ç»“æž„æ¯”å¯¹å·¥å…·ï¼Œæ”¯æŒäº¤äº’å¼å¤šè¡Œè¾“å…¥å’Œ AI åˆ†æž"
            homepage "https://bacchusgift.github.io/sql-diff/"
            url "https://github.com/Bacchusgift/sql-diff/archive/refs/tags/${VERSION}.tar.gz"
            sha256 "${SHA256}"
            license "MIT"
            head "https://github.com/Bacchusgift/sql-diff.git", branch: "main"

            depends_on "go" => :build

            def install
              # æž„å»ºæ ‡å¿—
              ldflags = %W[
                -s -w
                -X main.Version=#{version}
                -X main.BuildTime=#{time.iso8601}
              ]
              
              # ä»…åœ¨ HEAD ç‰ˆæœ¬ï¼ˆä»Ž Git å®‰è£…ï¼‰æ—¶æ·»åŠ  GitCommit
              if build.head?
                ldflags << "-X main.GitCommit=#{Utils.git_short_head}"
              end

              system "go", "build", *std_go_args(ldflags: ldflags), "./cmd/sql-diff"
              generate_completions_from_executable(bin/"sql-diff", "completion")
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/sql-diff --version")
              
              source_sql = "CREATE TABLE users (id INT PRIMARY KEY, name VARCHAR(100));"
              target_sql = "CREATE TABLE users (id INT PRIMARY KEY, name VARCHAR(100), email VARCHAR(255));"
              
              output = shell_output("#{bin}/sql-diff -s '#{source_sql}' -t '#{target_sql}'")
              assert_match "ADD COLUMN email", output
            end
          end
          EOF
          
          # æ›¿æ¢å˜é‡
          sed -i "s/\${VERSION}/$VERSION/g" Formula/sql-diff.rb
          sed -i "s/\${SHA256}/$SHA256/g" Formula/sql-diff.rb
          
          echo "âœ… Formula å·²æ›´æ–°:"
          cat Formula/sql-diff.rb

      - name: Commit and push
        run: |
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add Formula/sql-diff.rb
          git commit -m "chore: update sql-diff to ${{ needs.release.outputs.version }}"
          git push origin main
          
          echo "ðŸŽ‰ Homebrew Formula å·²è‡ªåŠ¨æ›´æ–°ï¼"
